<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script type="text/javascript" src="https://apis.google.com/js/api.js"></script>
    <style>
      body { padding: 20px; background-color: #fafafa; }
      .quiz-container { margin-top: 30px; }
      .card { margin-bottom: 20px; }
      .output-link, .error-message { margin-top: 20px; }
      .output-link a { font-weight: bold; color: #1565c0; }
      .error-message { color: #d32f2f; font-weight: bold; }
      .progress-bar-container { display: none; margin-top: 15px; }
      .instruction-input { margin-top: 10px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h4>Quiz Generator from Google Slides</h4>

      <div id="start-section" class="card-panel">
        <div class="input-field">
          <input id="quiz-url" type="text" placeholder="Paste Google Slides URL here...">
          <label for="quiz-url" class="active">Google Slides URL</label>
        </div>
        <div class="section">
          <a class="btn blue" onclick="generateQuizFromSlides()">Generate Quiz</a>
          <a class="btn grey" onclick="showPicker()">Pick from Drive</a>
        </div>
        <div id="start-error" class="error-message"></div>
      </div>

      <div class="progress-bar-container" id="progress">
        <div class="progress"><div class="indeterminate"></div></div>
      </div>

      <div id="quiz-ui" style="display: none;">
        <div id="quiz-meta" class="card-panel">
          <h5>Quiz Metadata</h5>
          <div class="input-field"><input id="quiz-title" type="text"><label for="quiz-title">Title</label></div>
          <div class="input-field"><input id="quiz-description" type="text"><label for="quiz-description">Description</label></div>
        </div>

        <div id="quiz-questions" class="quiz-container"></div>

        <div class="section">
          <a class="waves-effect waves-light btn green" onclick="regenerateQuiz()">Generate Updated Quiz</a>
          <a class="waves-effect waves-light btn blue" onclick="createQuizFiles()">Save Final Quiz</a>
        </div>

        <div id="result" class="output-link"></div>
        <div id="action-error" class="error-message"></div>
      </div>
    </div>

    <script>
      let quizData = {};
      let pickerApiLoaded = false;
      let jobId = null;
      const CLIENT_ID = 'YOUR_OAUTH_CLIENT_ID_HERE'; // <-- Replace this
      const DEVELOPER_KEY = 'YOUR_API_KEY_IF_NEEDED'; // Optional if using Apps Script scopes

      // On page load, check for URL parameters
      window.addEventListener('load', function() {
        google.script.url.getLocation(function(location) {
          if (location.parameters.jobId) {
            jobId = location.parameters.jobId[0];
            console.log("This session is part of Job ID:", jobId);
          }
          if (location.parameters.slideUrl) {
            const slideUrl = location.parameters.slideUrl[0];
            document.getElementById('quiz-url').value = decodeURIComponent(slideUrl);
            M.updateTextFields(); // For Materialize CSS to update label position
            // Automatically start the quiz generation if slide URL is present
            generateQuizFromSlides();
          }
        });
      });

      function showProgress(show = true) {
        document.getElementById("progress").style.display = show ? "block" : "none";
      }

      function setError(id, message) {
        document.getElementById(id).innerText = message || '';
      }

      function generateQuizFromSlides() {
        const url = document.getElementById("quiz-url").value.trim();
        if (!url) {
          setError('start-error', 'Please enter a valid Google Slides URL.');
          return;
        }

        setError('start-error');
        setError('action-error');
        showProgress(true);

        google.script.run
          .withSuccessHandler(function(data) {
            quizData = JSON.parse(data);
            renderQuizUI();
            document.getElementById("quiz-ui").style.display = "block";
            showProgress(false);
          })
          .withFailureHandler(function(error) {
            setError('start-error', 'Error generating quiz: ' + error.message);
            showProgress(false);
          })
          .generateQuizFromSlides(url);
      }

      function renderQuizUI() {
        document.getElementById("quiz-title").value = quizData.quiz.title || '';
        document.getElementById("quiz-description").value = quizData.quiz.description || '';
        M.updateTextFields();

        const container = document.getElementById("quiz-questions");
        container.innerHTML = "";

        quizData.quiz.questions.forEach((question, idx) => {
          const card = document.createElement("div");
          card.className = "card";

          card.innerHTML = `
            <div class="card-content">
              <span class="card-title">${question.label}</span>
              <div class="input-field">
                <input type="text" value="${question.text}" onchange="updateQuestionText(${idx}, this.value)">
                <label class="active">Question Text</label>
              </div>
              <div class="input-field instruction-input">
                <textarea class="materialize-textarea" onchange="updateInstructions(${idx}, this.value)" placeholder="LLM Instructions...">${question.instructions || ''}</textarea>
              </div>
              <ul class="collection">
                ${question.response.options.map((opt, i) => `
                  <li class="collection-item">
                    <div>
                      <input type="text" value="${opt.text}" onchange="updateOptionText(${idx}, ${i}, this.value)">
                      <label class="active">Option ${i + 1}</label>
                      <label style="margin-left:10px;">
                        <input type="checkbox" ${opt.correct ? "checked" : ""} onchange="toggleCorrect(${idx}, ${i})"/>
                        <span>Correct</span>
                      </label>
                    </div>
                  </li>
                `).join('')}
              </ul>
            </div>
          `;
          container.appendChild(card);
        });
      }

      function updateQuestionText(index, value) {
        quizData.quiz.questions[index].text = value;
      }

      function updateOptionText(qIndex, oIndex, value) {
        quizData.quiz.questions[qIndex].response.options[oIndex].text = value;
      }

      function toggleCorrect(qIndex, oIndex) {
        const option = quizData.quiz.questions[qIndex].response.options[oIndex];
        option.correct = !option.correct;
      }

      function updateInstructions(index, value) {
        quizData.quiz.questions[index].instructions = value;
      }

      function createQuizFiles() {
        clearFeedback();
        showProgress(true);
        quizData.quiz.title = document.getElementById("quiz-title").value;
        quizData.quiz.description = document.getElementById("quiz-description").value;

        google.script.run
          .withSuccessHandler(link => {
            showProgress(false);
            let message = jobId ? "View Final Module Package" : "View Quiz File";
            document.getElementById("result").innerHTML = `<a href="${link}" target="_blank">${message}</a>`;
          })
          .withFailureHandler(err => {
            setError('action-error', 'Failed to save quiz: ' + err.message);
            showProgress(false);
          })
          .createQuizFiles(quizData.quiz, jobId); // Pass jobId to the server
      }

      function regenerateQuiz() {
        const url = document.getElementById("quiz-url").value.trim();
        if (!url) {
          setError('start-error', 'Please enter a valid Google Slides URL.');
          return;
        }
        clearFeedback();
        showProgress(true);
        quizData.quiz.title = document.getElementById("quiz-title").value;
        quizData.quiz.description = document.getElementById("quiz-description").value;

        google.script.run
          .withSuccessHandler(updated => {
            showProgress(false);
            quizData = JSON.parse(updated);
            renderQuizUI();
          })
          .withFailureHandler(err => {
            setError('action-error', 'Failed to regenerate quiz: ' + err.message);
            showProgress(false);
          })
          .regenerateQuiz(quizData, url);
      }

      function clearFeedback() {
        setError('start-error');
        setError('action-error');
        document.getElementById("result").innerHTML = "";
      }

      // -------- Picker API Integration --------
      function showPicker() {
        gapi.load('auth', { 'callback': onAuthApiLoad });
        gapi.load('picker', { 'callback': onPickerApiLoad });
      }

      function onAuthApiLoad() {
        gapi.auth.authorize({
          'client_id': CLIENT_ID,
          'scope': ['https://www.googleapis.com/auth/drive.readonly'],
          'immediate': false
        }, handleAuthResult);
      }

      function onPickerApiLoad() {
        pickerApiLoaded = true;
      }

      function handleAuthResult(authResult) {
        if (authResult && !authResult.error) {
          const picker = new google.picker.PickerBuilder()
            .addView(google.picker.ViewId.PRESENTATIONS)
            .setOAuthToken(authResult.access_token)
            .setDeveloperKey(DEVELOPER_KEY)
            .setCallback(pickerCallback)
            .build();
          picker.setVisible(true);
        } else {
          setError('start-error', 'Authorization failed.');
        }
      }

      function pickerCallback(data) {
        if (data.action === google.picker.Action.PICKED) {
          const doc = data.docs[0];
          const url = doc.url;
          document.getElementById("quiz-url").value = url;
          M.updateTextFields();
        }
      }
    </script>
  </body>
</html>
